<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://unpkg.com/face-api.js"></script> 
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        #input-container {
            margin-bottom: 20px;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
        }
        #preview {
            max-width: 100%;
            max-height: 600px;
        }
    </style>
</head>
<body>
    <h1>Face Recognition</h1>
    <p id="status">Loading models...</p>

    <div id="input-container">
        <input type="file" id="imageInput" accept="image/*">
        <p>Upload an image to test the model</p>
        <img id="preview" src="" alt="Image Preview">
    </div>

    <div id="result">
        <h2>Prediction:</h2>
        <p id="prediction" class="loading">No prediction yet</p>
    </div>

    <canvas id="overlay"></canvas> 

    <script>
        const modelURL = 'https://cdn.jsdelivr.net/npm/face-api.js/dist/'; // Using a CDN for models
        const knownFaceEmbeddings = []; // Array to store known face embeddings
        const knownPersonNames = []; // Array to store names for known people

        let faceMatcher;

        // Load face-api.js models
        async function loadModels() {
            try {
                await faceapi.loadSsdMobilenetv1Model(modelURL);
                await faceapi.loadFaceLandmarkModel(modelURL);
                await faceapi.loadFaceRecognitionModel(modelURL);
                console.log('Models loaded successfully');
                document.getElementById('status').innerText = 'Models loaded successfully!';
            } catch (error) {
                console.error('Error loading models:', error);
                document.getElementById('status').innerText = 'Failed to load models. Check model URLs.';
            }
        }

        loadModels();

        // Handle image file input
        document.getElementById('imageInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const preview = document.getElementById('preview');
            preview.src = URL.createObjectURL(file);

            preview.onload = async () => { 
                const canvas = document.getElementById('overlay');
                faceapi.matchDimensions(canvas, preview); 

                try {
                    const detections = await faceapi.detectAllFaces(preview)
                        .withFaceLandmarks()
                        .withFaceDescriptors();

                    if (detections.length > 0) {
                        // Create a FaceMatcher instance
                        const descriptors = detections.map(d => d.descriptor);
                        faceMatcher = new faceapi.FaceMatcher(descriptors, knownPersonNames, 0.6); // Use a threshold of 0.6

                        const results = detections.map(d => {
                            const bestMatch = faceMatcher.findBestMatch(d.descriptor);
                            return `${bestMatch.label} (distance: ${bestMatch.distance})`;
                        });

                        document.getElementById('prediction').innerHTML = results.join('<br>');
                    } else {
                        document.getElementById('prediction').innerText = 'No faces detected.';
                    }

                    faceapi.draw.drawDetections(canvas, detections); 
                    faceapi.draw.drawFaceLandmarks(canvas, detections); 
                } catch (error) {
                    console.error('Error during prediction:', error);
                    document.getElementById('prediction').innerText = `Prediction failed: ${error.message}`; 
                }
            };
        });

        // Example: Add known face descriptors (manually or through a known person's image)
        async function addKnownFace() {
            const image = await faceapi.fetchImage('path_to_known_person_image'); // Replace with an actual path
            const detections = await faceapi.detectSingleFace(image).withFaceLandmarks().withFaceDescriptor();
            if (detections) {
                knownFaceEmbeddings.push(detections.descriptor);
                knownPersonNames.push('Known Person'); // Replace with the person's name
            }
        }

        // Call this function to add known faces before testing
        // addKnownFace();
    </script>
</body>
</html>

img.onload = async () => {
  try {
    // Resize canvas to match the model's input dimensions
    canvas.width = 224;
    canvas.height = 224;
    ctx.drawImage(img, 0, 0, 224, 224);

    // Prepare the image data for prediction
    const imageData = tf.browser.fromPixels(canvas).expandDims(0).toFloat().div(255.0);

    // Get predictions from the model
    const prediction = model.predict(imageData);
    const result = await prediction.array();

    // Debugging: Log the raw prediction result
    console.log('Raw prediction result:', result);

    // Define the categories (ensure they match the model's outputs)
    const categories = ['Happy', 'Sad', 'Neutral', 'Angry']; // Example categories

    // Check if the model's output matches the categories array
    if (!result[0] || result[0].length !== categories.length) {
      document.getElementById('prediction').innerText =
        'Error: Mismatch between model outputs and categories.';
      console.error('Mismatch: Model outputs', result[0]?.length, 'categories', categories.length);
      return;
    }

    // Find the highest probability and its corresponding category
    const maxProbability = Math.max(...result[0]); // Find the highest probability
    const predictionIndex = result[0].indexOf(maxProbability); // Find its index
    const predictionText = categories[predictionIndex]; // Map to category name
    const predictionConfidence = (maxProbability * 100).toFixed(2); // Convert to percentage

    // Display the prediction
    document.getElementById('prediction').innerText = `Prediction: ${predictionText} (${predictionConfidence}%)`;
  } catch (error) {
    console.error('Error during prediction:', error);
    document.getElementById('prediction').innerText = 'Prediction failed. Check console for details.';
  }
};
